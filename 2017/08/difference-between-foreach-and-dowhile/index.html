<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 从Smali代码的角度看foreach和dowhile的区别 · SAM EZ GUD</title><meta name="description" content="从Smali代码的角度看foreach和dowhile的区别 - Sam Tsai"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="https://raw.githubusercontent.com/0x0010/notebook/master/resources/virus-min.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://0x0010.com/atom.xml" title="SAM EZ GUD"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="https://raw.githubusercontent.com/0x0010/notebook/master/resources/virus-min.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/0x0010" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">从Smali代码的角度看foreach和dowhile的区别</h1><div class="post-info">Aug 16, 2017</div><div class="post-content"><p>最近被问到一个问题：foreach和dowhile的区别（编译之后）。刚拿到这个问题时，一时真不知道怎么作答。不过他们的用法和共同点对于程序员来说都不陌生。那么jdk是如何编译foreach代码的呢？我们准备将Java代码编译成<a href="&quot;https://github.com/JesusFreke/smali&quot;">smali</a>代码来一探究竟。</p>
<a id="more"></a>
<h3 id="foreach代码解读"><a href="#foreach代码解读" class="headerlink" title="foreach代码解读"></a>foreach代码解读</h3><p>先写一段foreach代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">  <span class="keyword">char</span>[] chars = &#123;<span class="string">'h'</span>, <span class="string">'a'</span>, <span class="string">'y'</span>&#125;;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">char</span> ch : chars) &#123;</div><div class="line">    System.out.println(ch);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码很简单，不做过多解释了。下面我们将以上代码编译成smali，看看编译后的foreach长啥样。</p>
<p>代码部分添加了注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">.method public static main([Ljava/lang/String;)V</div><div class="line">    .registers 6</div><div class="line">    .param p0, &quot;args&quot;    # [Ljava/lang/String;</div><div class="line"></div><div class="line">    .prologue</div><div class="line">    .line 12</div><div class="line">    const/4 v2, 0x3  #定义变量v2=3</div><div class="line"></div><div class="line">    new-array v1, v2, [C  #构造长度为3的char数组</div><div class="line"></div><div class="line">    fill-array-data v1, :array_16 #使用array16填充数据，array16在方法尾部。</div><div class="line"></div><div class="line">    .line 13</div><div class="line">    .local v1, &quot;chars&quot;:[C</div><div class="line">    array-length v3, v1  #求字符数组v1长度，赋值v3=3</div><div class="line"></div><div class="line">    const/4 v2, 0x0  #循环变量v2 初始值为0</div><div class="line"></div><div class="line">    :goto_8  #循环开始</div><div class="line">    if-ge v2, v3, :cond_14  #如果循环变量大于等于3 跳到cond_14, 执行结束</div><div class="line"></div><div class="line">	# 如下代码是打印char[v2]字符</div><div class="line">    aget-char v0, v1, v2</div><div class="line"></div><div class="line">    .line 14</div><div class="line">    .local v0, &quot;ch&quot;:C</div><div class="line">    sget-object v4, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</div><div class="line"></div><div class="line">    invoke-virtual &#123;v4, v0&#125;, Ljava/io/PrintStream;-&gt;println(C)V</div><div class="line">    # 打印字符结束</div><div class="line">    .line 13</div><div class="line">    add-int/lit8 v2, v2, 0x1 #循环变量v2=v2+1</div><div class="line"></div><div class="line">    goto :goto_8 #进入下一次循环</div><div class="line"></div><div class="line">    .line 16</div><div class="line">    .end local v0    # &quot;ch&quot;:C</div><div class="line">    :cond_14</div><div class="line">    return-void</div><div class="line"></div><div class="line">    .line 12</div><div class="line">    nop</div><div class="line"></div><div class="line">    :array_16</div><div class="line">    .array-data 2</div><div class="line">        0x68s</div><div class="line">        0x61s</div><div class="line">        0x79s</div><div class="line">    .end array-data</div><div class="line">.end method</div></pre></td></tr></table></figure>
<p>从以上smali代码能明显感觉到，这很像while语法，翻译成while语法看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">  <span class="keyword">char</span>[] chars = &#123;<span class="string">'h'</span>, <span class="string">'a'</span>, <span class="string">'y'</span>&#125;;</div><div class="line">  <span class="keyword">int</span> v2 = <span class="number">0</span>, v3 = chars.length;</div><div class="line">  <span class="keyword">while</span> (v2 &lt; v3) &#123;</div><div class="line">    System.out.println(chars[v2]);</div><div class="line">    v2++;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是很常见的while写法。</p>
<h3 id="foreach与dowhile的区别"><a href="#foreach与dowhile的区别" class="headerlink" title="foreach与dowhile的区别"></a>foreach与dowhile的区别</h3><p>dowhile的写法不用多说了，所以这个问题就转化成while和dowhile的区别。</p>
<p>Oracle的j2se文档是这么总结的：</p>
<p><em>dowhile与while的区别是，dowhile在循环的尾部计算表达式。因此do代码块总会执行至少一次。</em></p>
<blockquote>
<p>The difference between <code>do-while</code> and <code>while</code> is that <code>do-while</code> evaluates its expression at the bottom of the loop instead of the top. Therefore, the statements within the <code>do</code> block are always executed at least once, as shown in the following <a href="https://docs.oracle.com/javase/tutorial/java/nutsandbolts/examples/DoWhileDemo.java" target="_blank" rel="external"><code>DoWhileDemo</code></a> program:</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoWhileDemo</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">        <span class="keyword">int</span> count = <span class="number">1</span>;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            System.out.println(<span class="string">"Count is: "</span> + count);</div><div class="line">            count++;</div><div class="line">        &#125; <span class="keyword">while</span> (count &lt; <span class="number">11</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><ol>
<li>Oracle Java Document  <a href="https://docs.oracle.com/javase/tutorial/java/nutsandbolts/while.html" target="_blank" rel="external">The while and do-while Statements</a> </li>
<li>smali项目地址 <a href="https://github.com/JesusFreke/smali" target="_blank" rel="external">https://github.com/JesusFreke/smali</a></li>
<li>Intellij Idea 安装使用smali <a href="https://github.com/JesusFreke/smali/wiki/smalidea" target="_blank" rel="external">https://github.com/JesusFreke/smali/wiki/smalidea</a></li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2017/08/two-types-of-method-synchronized/" class="prev">上一篇</a><a href="/2017/07/monitor-system-based-on-influxdb-grafana/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://0x0010.com">Sam Tsai</a>, Thanks Github.</p><p>Feel free to contact me: sam.ez.gud'AT'gmail.com</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>